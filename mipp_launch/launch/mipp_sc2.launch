<?xml version="1.0"?>
<launch>
  <arg name="run_gazebo"  default="true"/>
  <arg name="world_file_name"   default="sc2/shapes_2_rand" />
  <arg name="world_path"        default="$(find mipp_gazebo)/worlds/$(arg world_file_name).world" />
  <arg name="gui"         default="false"/>
  <arg name="run_rviz"    default="true"/>
  <arg name="run_husky"   default="true"/>
  <arg name="run_uavs"    default="true"/>
  <arg name="nr_of_uavs"  default="2"/>
  <arg name="uav_planner_rate"          default="150.0"/>
  <arg name="run_mipp_planner"          default="true"/>
  <arg name="com_range"                 default="10.0"/>
  <arg name="octomap_rate"              default="2.0"/>
  <arg name="octomap_cloud_topic"    default="/octomap/points"/>

  <arg name="ugv_start_x"              default="-25.0"/>
  <arg name="ugv_start_y"              default="-25.0"/>

  <node pkg="tf" type="static_transform_publisher" name="tf_map_odom_link" args="0 0 0 0 0 0  /map /odom  10"/>
  <node pkg="tf" type="static_transform_publisher" name="tf_world_map_link" args="0 0 0 0 0 0  /world /map  10"/>
  <node pkg="tf" type="static_transform_publisher" name="tf_base_frd_link" args="0 0 0 0 0 0  /world /base_link_frd  10"/>



  <!---
    Run OctoMap
  -->
  <include file="$(find mipp_launch)/launch/octomap_mapping.launch">
    <arg name="resolution"                      value="0.20"/>
    <arg name="frame_id"                        value="world"/>
		<arg name="base_frame_id"                   value="base_footprint"/>
		<arg name="sensor_model/max_range"          value="7.0"/>
  	<arg name="latch"                           value="false"/>
		<arg name="filter_ground"                   value="false"/>
		<arg name="pointcloud_min_z"                value="0.1"/>
		<arg name="pointcloud_max_z"                value="5.0"/>
		<arg name="occupancy_min_z"                value="0.2"/>
		<arg name="occupancy_max_z"                value="5.0"/>
	  <remap from="cloud_in"          to="$(arg octomap_cloud_topic)" />
  </include>

  <!--- 
    Spawn first uav
  -->
  <include file="$(find mipp_launch)/launch/uav.launch" if="$(eval arg('nr_of_uavs') >= 1)">
    <arg name="uav_id"                    value="0"/>
    <arg name="initial_x"                 value="$(eval arg('ugv_start_x')+3)"/>
    <arg name="initial_y"                 value="$(eval arg('ugv_start_y')+0)"/>
    <arg name="uav_planner_rate"          value="$(arg uav_planner_rate)"/>
    <arg name="com_range"                 value="$(arg com_range)"/>
    <arg name="octomap_throttle_rate"     value="$(arg octomap_rate)"/>
    <arg name="octomap_cloud_topic"       value="$(arg octomap_cloud_topic)"/>
  </include>

  <!--- 
    Spawn second uav
  -->
  <include file="$(find mipp_launch)/launch/uav.launch" if="$(eval arg('nr_of_uavs') >= 2)">
    <arg name="uav_id"        value="1"/>
    <arg name="initial_x"                 value="$(eval arg('ugv_start_x')-2)"/>
    <arg name="initial_y"                 value="$(eval arg('ugv_start_y')-2)"/>
    <arg name="uav_planner_rate"          value="$(arg uav_planner_rate)"/>
    <arg name="com_range"                 value="$(arg com_range)"/>
    <arg name="octomap_throttle_rate"     value="$(arg octomap_rate)"/>
    <arg name="octomap_cloud_topic"       value="$(arg octomap_cloud_topic)"/>
  </include>

  <!--- 
    Spawn third uav
  -->
  <include file="$(find mipp_launch)/launch/uav.launch" if="$(eval arg('nr_of_uavs') >= 3)">
    <arg name="uav_id"        value="2"/>
    <arg name="initial_x"                 value="$(eval arg('ugv_start_x')-2)"/>
    <arg name="initial_y"                 value="$(eval arg('ugv_start_y')+2)"/>
    <arg name="uav_planner_rate"          value="$(arg uav_planner_rate)"/>
    <arg name="com_range"                 value="$(arg com_range)"/>
    <arg name="octomap_throttle_rate"     value="$(arg octomap_rate)"/>
    <arg name="octomap_cloud_topic"       value="$(arg octomap_cloud_topic)"/>
  </include>

  <!-- Load custom console configuration -->
  <env name="ROSCONSOLE_CONFIG_FILE" value="$(find mipp_launch)/resource/custom_rosconsole.conf"/>

  <!-- Launch rqt_reconfigure -->
  <node pkg="rqt_reconfigure" type="rqt_reconfigure" output="screen" name="rqt_reconfigure" />

  <!--- 
    Run Gazebo 
  -->
  <include file="$(find mipp_gazebo)/launch/mipp_gazebo.launch" if="$(arg run_gazebo)">
      <arg name="gui" value="$(arg gui)"/>
      <arg name="world_path" value="$(arg world_path)" />
  </include>

  <!--- 
    Run Rviz 
  -->
  <node name="rviz" pkg="rviz" type="rviz" output="log" args="-d $(find mipp_viz)/rviz/mipp_main.rviz"  if="$(arg run_rviz)"/>

  <!--- 
    Spawn single husky
  -->
  <arg name="ugv_ns"  default="/ugv"/>
  <group if="$(arg run_husky)">
    <include file="$(find mipp_launch)/launch/husky.launch">
      <arg name="robot_namespace"         value="$(arg ugv_ns)"/>
      <arg name="x"                       value="$(arg ugv_start_x)"/>
      <arg name="y"                       value="$(arg ugv_start_y)"/>
      <arg name="no_static_map"           value="false"/>
      <arg name="no_sensor"               value="true"/>
    </include>
  </group>

  <!--- 
    Mipp server
  -->
  <group if="$(arg run_mipp_planner)">
    <include file="$(find mipp_packages)/launch/mipp_planner.launch">
      <arg name="nr_of_uavs"    value="$(arg nr_of_uavs)"/>
      <arg name="com_range"     value="$(arg com_range)"/>
      <arg name="ugv_ns"        value="/ugv/"/>
      <arg name="ugv_start_x"   value="$(arg ugv_start_x)"/>
      <arg name="ugv_start_y"   value="$(arg ugv_start_y)"/>
    </include>
  </group>
  
  <!-- 
    Map server 
  -->
  <arg name="map_file" default="$(find mipp_gazebo)/worlds/$(arg world_file_name)_map.yaml"/>
  <node pkg="map_server" type="map_server" name="map_server" output="screen" args="$(arg map_file)">
  </node>

  <!--- 
    Run visualizer
  -->
  <node name="mipp_visualizer_node" pkg="mipp_packages" type="mipp_visualizer_node">
    <param name="nr_of_uavs"                value="$(arg nr_of_uavs)" />
  </node>

  <!--- 
    Run monitor
  -->
  <node name="mipp_monitor_node" pkg="mipp_packages" type="mipp_monitor_node">
    <param name="nr_of_uavs"                value="$(arg nr_of_uavs)" />
    <param name="write_path"                value="false" />
    <param name="read_path"                 value="true" />
    <param name="path_file_name"            value="/home/kevin/catkin_ws/src/mipp_project/mipp_launch/bags/sc2_path_1.bag" />
  </node>

</launch>
